@using Microsoft.AspNetCore.Identity
@using FinancePortal.Services
@using FinancePortal.Data
@using FinancePortal.Enums

@inject IImageService ImageService
@inject UserManager<FPUser> UserManager
@inject ApplicationDbContext Context

@model FinancePortal.Models.View_Models.HouseholdViewModel

@{
    ViewData["Title"] = "Welcome to Your Dashboard";

}

<div class="d-flex justify-content-between mb-2">
    <h1 class="text-success">@ViewData["Title"]</h1>

</div>

@if (TempData["Message"] != null)
{
    <h1 class="text-danger">@TempData["Message"]</h1>
}


<div class="container-fluid">
    <div class="container-fluid">
        <img src="~/images/Finance-1.jpg" style="width:100%; height:350px" />
    </div>
    <br />
    <hr />

    <div class="row">
        <!------------------------->
        <!-- Household Occupants -->
        <!------------------------->
        <div class="col-md-4">
            <div id="card-580792">
                <div class="card">
                    <div class="card-header bg-light">
                        <div id="Account-members-btn" class="btn btn-outline-success" data-toggle="collapse" data-parent="#card-580792" href="#card-element-707760">House Members</div>
                    </div>
                    <div id="card-element-707760" class="collapse show">
                        <div class="card-body">
                            <table class="table m-b-0 table-hover">
                                <thead class="thead-success">
                                    <tr>
                                        <th>First Name</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in Model.Household.Occupants)
                                    {
                                        <tr>
                                            <td>@user.FirstName</td>
                                            <td>
                                                @UserManager.GetRolesAsync(user).Result.FirstOrDefault()
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            @if (User.IsInRole(nameof(HouseholdRole.HEAD)))
                            {
                                <a class="btn btn-outline-success" data-toggle="modal" data-target="#Invitations">Create New Invitation</a>
                                <a class="btn btn-outline-info" data-toggle="modal" data-target="#ReviewInvitations">Review Invitations</a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-------------------------->
        <!-- Bank Accounts Ledger -->
        <!-------------------------->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-light">
                    <div id="Bank-account-btn" class="btn btn-outline-success" area-expanded="false" data-toggle="collapse" data-target="#BankAccounts">Bank Accounts Ledger</div>
                </div>
                <div class="card-body collapse" id="BankAccounts">
                    <table class="table m-b-0 table-hover">
                        <thead class="thead-success">
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Current Balance</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var account in Model.Household.BankAccounts)
                            {
                                <tr>
                                    <td>
                                        @account.Name
                                    </td>
                                    <td>
                                        @account.AccountType
                                    </td>
                                    <td>
                                        @account.CurrentBalance
                                    </td>
                                    <td>
                                        <a class="btn btn-outline-success" asp-controller="HouseholdBankAccounts" asp-action="Edit" asp-route-id="@account.Id">Edit</a>
                                        <a class="btn btn-outline-success" asp-controller="HouseholdBankAccounts" asp-action="Details" asp-route-id="@account.Id">Details</a>
                                        <a class="btn btn-outline-danger" asp-controller="HouseholdBankAccounts" asp-action="Delete" asp-route-id="@account.Id">Delete</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <a class="btn btn-outline-success" data-toggle="modal" data-target="#Transactions">Create New Transaction</a>
                </div>
            </div>
        </div>
    </div>

    <!------------------------>
    <!--Transactions Ledger -->
    <!------------------------>
    <div class="row">
        <div class="col-md-12">
            <div id="card-19881">
                <div class="card">
                    <div class="card-header bg-light">
                        <a class="card-link collapsed btn btn-outline-success" data-toggle="collapse" data-parent="#card-19881" href="#card-element-712477">Transaction Ledger</a>
                    </div>
                    <div id="card-element-712477" class="collapse">
                        <div class="card-body">
                            <table class="table m-b-0 table-hover">
                                <thead class="thead-success">
                                    <tr>
                                        <th>Category Item</th>
                                        <th>Bank Account</th>
                                        <th>User Name</th>
                                        <th>Created</th>
                                        <th>Memo</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var transaction in Model.Transactions)
                                    {
                                        <tr>
                                            <td>
                                                @transaction.CategoryItemId
                                            </td>
                                            <td>
                                                @transaction.HouseholdBankAccount.Household
                                            </td>
                                            <td>
                                                @transaction.FPUser.FirstName
                                            </td>
                                            <td>
                                                @transaction.Created.Date
                                            </td>
                                            <td>
                                                @transaction.Memo
                                            </td>
                                            <td>
                                                @transaction.Amount
                                            </td>
                                            <td>
                                                <a class="btn btn-outline-success" asp-controller="Transactions" asp-action="Edit" asp-route-id="@transaction.Id">Edit</a>
                                                <a class="btn btn-outline-success" asp-controller="Transactions" asp-action="Details" asp-route-id="@transaction.Id">Details</a>
                                                <a class="btn btn-outline-danger" asp-controller="Transactions" asp-action="Delete" asp-route-id="@transaction.Id">Delete</a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!------------------------>
    <!-- Bal & Trans Charts -->
    <!------------------------>
    <div class="row">
        <div class="col-6">
            <div class="card">
                <h6 class="card-header bg-light text-success">
                    Current Balance
                </h6>
                <div class="card-body">
                    <div height="400" id="currentBalanceChart">

                    </div>
                </div>
                <div class="footer bg-transparent">

                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card">
                <h6 class="card-header bg-light text-success">
                    Recent Transactions
                </h6>
                <div class="card-body">
                    <div height="400" id="TransactionChart">

                    </div>
                </div>
                <div class="footer bg-transparent">

                </div>
            </div>
        </div>
    </div>

    <!---------------->
    <!-- Categories -->
    <!---------------->

    <div class="row">
        <div class="col-md-12">
            <div id="card-345678">
                <div class="card">
                    <div class="card-header bg-light">
                        <div id="Categories" class="btn btn-outline-success" data-toggle="collapse" data-parent="#card-345678" href="#card-element-456789">Category Ledger</div>
                    </div>
                    <div id="card-element-456789" class="collapse show">
                        <div class="card-body">
                            <table class="table m-b-0 table-hover">
                                <thead class="thead-success">
                                    <tr>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var householdCategory in Model.HouseholdCategories)
                                    {
                                        <tr>
                                            <td>
                                                @householdCategory.Description
                                            </td>
                                            <td>
                                                @householdCategory.TargetAmount
                                            </td>
                                            <td>
                                                <a class="btn btn-outline-success" asp-controller="HouseholdCategories" asp-action="Edit" asp-route-id="@householdCategory.Id">Edit</a>
                                                <a class="btn btn-outline-success" asp-controller="HouseholdCategories" asp-action="Details" asp-route-id="@householdCategory.Id">Details</a>
                                                <a class="btn btn-outline-danger" asp-controller="HouseholdCategories" asp-action="Delete" asp-route-id="@householdCategory.Id">Delete</a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-------------------->
                <!-- Category Items -->
                <!-------------------->
                <div class="row">
                    <div class="col-md-12">
                        <div id="card-567890">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <div id="CategoryItems" class="btn btn-outline-success" data-toggle="collapse" data-parent="#card-567890" href="#card-element-678901">Category Item Ledger</div>
                                </div>
                                <div id="card-element-678901" class="collapse">
                                    <div class="card-body">
                                        <table class="table m-b-0 table-hover">
                                            <thead class="thead-success">
                                                <tr>
                                                    <th>Category Item</th>
                                                    <th>Description</th>
                                                    <th>Target Amount</th>
                                                    <th>Actual Amount</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var categoryItem in Model.CategoryItems)
                                                {
                                                    <tr>
                                                        <td>
                                                            @categoryItem.Name
                                                        </td>
                                                        <td>
                                                            @categoryItem.Description
                                                        </td>
                                                        <td>
                                                            @categoryItem.TargetAmount
                                                        </td>
                                                        <td>
                                                            @categoryItem.ActualAmount
                                                        </td>
                                                        <td>
                                                            <a class="btn btn-outline-success" asp-controller="CategoryItems" asp-action="Edit" asp-route-id="@categoryItem.Id">Edit</a>
                                                            <a class="btn btn-outline-success" asp-controller="CategoryItems" asp-action="Details" asp-route-id="@categoryItem.Id">Details</a>
                                                            <a class="btn btn-outline-danger" asp-controller="CategoryItems" asp-action="Delete" asp-route-id="@categoryItem.Id">Delete</a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!------------------------------>
<!-- Create Invitations Modal -->
<!------------------------------>
<div class="modal" id="Invitations">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-success">Create Invitation</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <form asp-controller="HouseholdInvitations" asp-action="Create" class="ml-2 mr-2" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                @Html.Hidden("HouseholdId", Model.HouseholdId)

                <div class="form-group">
                    <label class="control-label">Expires</label>
                    <input type="date" name="Expires" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Email To</label>
                    <input name="EmailTo" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Subject</label>
                    <input name="Subject" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Body</label>
                    <input name="Body" class="form-control" />
                </div>
                <div class="form-group">
                    <input type="submit" value="Create" class="btn btn-outline-success" />
                </div>
            </form>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<!------------------------------>
<!-- Review Invitations Modal -->
<!------------------------------>
<div class="modal" id="ReviewInvitations">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header ml-2 mr-2">
                <h4 class="modal-title text-success">Review Invitations</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <table class="table m-b-0 table-hover">
                <thead class="thead-success">
                    <tr>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Accepted</th>
                        <th>IsValid</th>
                        <th>Email</th>
                        @*<th>Action</th>*@
                    </tr>
                </thead>
                <tbody>
                    @foreach (var householdInvitation in Model.Household.Invitations)  
                    {
                        <tr>
                            <td>
                                @householdInvitation.Created
                            </td>
                            <td>
                                @householdInvitation.Expires
                            </td>
                            <td>
                                @householdInvitation.Accepted
                            </td>
                            <td>
                                @householdInvitation.IsValid
                            </td>
                            <td>
                                @householdInvitation.EmailTo
                            </td>
                            @*<td>
                                <a class="btn btn-outline-success" asp-controller="HouseholdInvitations" asp-action="Edit" asp-route-id="@householdInvitation.Id">Edit</a>
                                <a class="btn btn-outline-success" asp-controller="HouseholdInvitations" asp-action="Details" asp-route-id="@householdInvitation.Id">Details</a>
                                <a class="btn btn-outline-danger" asp-controller="HouseholdInvitations" asp-action="Delete" asp-route-id="@householdInvitation.Id">Delete</a>
                            </td>*@
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<!------------------------------->
<!-- Create Transactions Modal -->
<!------------------------------->
<div class="modal fade" id="Transactions">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title text-success">Create Transaction</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <form asp-controller="Transactions" asp-action="Create" class="ml-2 mr-2" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                @Html.Hidden("HouseholdId", Model.HouseholdId)

                <div class="form-group">
                    <label class="control-label">Category Item</label>
                    <select name="CategoryItemId" asp-items="ViewBag.CategoryItemId" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="control-label">HouseholdBankAccount</label>
                    <select name="HouseholdBankAccountId" asp-items="ViewBag.HouseholdBankAccountId" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="control-label">Type</label>
                    <select name="Type" class="form-control" asp-items="@Html.GetEnumSelectList<TransactionType>()"></select>
                </div>
                <div class="form-group">
                    <label class="control-label">Memo</label>
                    <input name="Memo" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="control-label">Amount</label>
                    <input name="Amount" class="form-control" type="number" step="any" min="0.01" max="99999999.99" />
                </div>
                <div class="form-group">
                    <input type="submit" value="Create" class="btn btn-outline-success" />
                </div>
            </form>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
   
<!------------------------>
<!-- Charts Start Here -->
<!------------------------>

@await Html.PartialAsync("_InvitationPartial", Model.HouseholdInvitation)


@section Scripts {

    <script>
        $("#findme").on("click", (el) => { console.log(el.target) })
    </script>

    <script>
        //Step 1 - Construct the URL needed to request the data
        var Url1 = '@Url.Action("CurrentBalanceChart", "Charts")'; // represent the endpoint
        var Url2 = '@Url.Action("TransactionChart", "Charts")'; // represent the endpoint

        //Step 2 - start the structure for our AJAX call
        $.post(Url1).then(function (response) {
           // console.log(response)
            let labelsarray = [];
            let seriesarray = [];
            response.forEach((el) => {
                labelsarray.push(el.labels);
                seriesarray.push(el.values);
            });
            var options = {
                labelInterpolationFnc: function (value) {
                    return value[0]
                }
            };
            var responsiveOptions = [
                ['screen and (min-width: 640px)', {
                    chartPadding: 20,
                    labelOffset: 50,
                    labelDirection: 'explode',
                    labelInterpolationFnc: function (value, i) {
                        return seriesarray[i] + ' ' + value;
                    }
                }],
                ['screen and (min-width: 1024px)', {
                    labelOffset: 40,
                    chartPadding: 20
                }]
            ]; var data = {
                labels: labelsarray,
                series: seriesarray
            };
            console.log(labelsarray, seriesarray);
            Chartist.Pie('#currentBalanceChart', data,options, responsiveOptions);
        });
            $.post(Url2).then(function (response) {
                // console.log(response)
                let labelsarray = [];
                let seriesarray = [];
                response.forEach((el) => {
                    labelsarray.push(el.labels);
                    seriesarray.push(el.values);

                });
                var options = {
                    labelInterpolationFnc: function (value) {
                        return value[0]
                    }
                };
                var responsiveOptions = [
                    ['screen and (min-width: 640px)', {
                        chartPadding: 20,
                        labelOffset: 50,
                        labelDirection: 'explode',
                        labelInterpolationFnc: function (value, i) {
                            return seriesarray[i] + ' ' + value;
                        }
                    }],
                    ['screen and (min-width: 1024px)', {
                        labelOffset: 40,
                        chartPadding: 20
                    }]
                ]; var data = {
                    labels: labelsarray,
                    series: seriesarray
                };
                console.log(labelsarray, seriesarray);
                Chartist.Pie('#TransactionChart', data, options, responsiveOptions);
            });


    </script>

}
